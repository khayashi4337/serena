# Serenaのコアコンセプトとアーキテクチャ

## ハイレベルアーキテクチャ

Serenaは、2層のアーキテクチャで構築されています。

1.  **SerenaAgent** - プロジェクト、ツール、ユーザーとの対話を管理する主要なオーケストレーター
2.  **SolidLanguageServer** - Language Server Protocol (LSP) の実装を統一的にラップするもの

## コアコンポーネント

### 1. SerenaAgent (`src/serena/agent.py`)

以下を行う中央コーディネーターです。
-   アクティブなプロジェクトとその設定を管理
-   異なるツールとコンテキスト間を調整
-   言語サーバーのライフサイクルを処理
-   メモリの永続化を管理
-   MCP (Model Context Protocol) サーバーインターフェースを提供

主な責務:
-   **プロジェクト管理** - プロジェクトのアクティベート、切り替え
-   **ツールレジストリ** - コンテキスト/モードに基づいて利用可能なツールを読み込み、管理
-   **言語サーバー統合** - プロジェクトごとに言語サーバーを起動/停止
-   **メモリ管理** - プロジェクト知識の永続的ストレージ
-   **タスク実行** - 複雑な複数ステップの操作を調整

### 2. SolidLanguageServer (`src/solidlsp/ls.py`)

複数の言語サーバーを統一的に抽象化し、以下を提供します。
-   シンボル操作のための**言語に依存しないインターフェース**
-   パフォーマンス最適化のための**キャッシング層**
-   信頼性の低い言語サーバーのための**エラーハンドリングと回復**
-   基盤となるLSP実装に関わらない**統一API**

主要な機能:
-   シンボルの発見とナビゲーション
-   コード補完とホバー情報
-   参照と定義の検索
-   ドキュメントとワークスペースのシンボル検索
-   ファイルの監視と変更通知

### 3. ツールシステム (`src/serena/tools/`)

いくつかのカテゴリを持つモジュラーなツールアーキテクチャです。

#### ファイルツール (`file_tools.py`)
-   ファイルシステム操作 (読み取り、書き込み、ディレクトリ一覧)
-   テキスト検索とパターンマッチング
-   正規表現ベースの置換

#### シンボルツール (`symbol_tools.py`)
-   言語を意識したシンボルの検索とナビゲーション
-   シンボル本体の置換と挿入
-   コードベース全体での参照検索

#### メモリツール (`memory_tools.py`)
-   プロジェクト知識の永続化
-   メモリの取得と管理
-   オンボーディング情報の保存

#### 設定ツール (`config_tools.py`)
-   プロジェクトのアクティベートと切り替え
-   モードとコンテキストの管理
-   ツールの包含/除外

## 設定システム (`src/serena/config/`)

以下をサポートする多層的な設定です。
-   **コンテキスト** - 利用可能なツールとその振る舞いを定義
-   **モード** - 操作パターン (インタラクティブ、編集など) を指定
-   **プロジェクト** - プロジェクトごとの設定と言語サーバー設定
-   **ツールセット** - さまざまなユースケースのためのグループ化されたツールのコレクション

## 言語サーバー統合

### 言語サポートモデル

サポートされている各言語には、以下があります。
1.  **言語サーバー実装** (`src/solidlsp/language_servers/`)
2.  **ランタイム依存関係** - 言語サーバーのダウンロードを管理
3.  **テストリポジトリ** (`test/resources/repos/<language>/`)
4.  **テストスイート** (`test/solidlsp/<language>/`)

### 言語サーバーのライフサイクル

1.  **発見** - 言語サーバーを検索するか、自動的にダウンロード
2.  **初期化** - サーバープロセスを開始し、LSPハンドシェイクを実行
3.  **プロジェクト設定** - ワークスペースを開き、言語固有の設定を構成
4.  **操作** - キャッシングとエラー回復を伴うリクエスト/レスポンスを処理
5.  **シャットダウン** - サーバープロセスをクリーンにシャットダウン

### サポートされている言語

現在サポートされている言語は以下の通りです。
-   **C#** - Microsoft.CodeAnalysis.LanguageServer (.NET 9)
-   **Python** - Pyright または Jedi
-   **TypeScript/JavaScript** - TypeScript Language Server
-   **Rust** - rust-analyzer
-   **Go** - gopls
-   **Java** - Eclipse JDT Language Server
-   **Kotlin** - Kotlin Language Server
-   **PHP** - Intelephense
-   **Ruby** - Solargraph
-   **Clojure** - clojure-lsp
-   **Elixir** - ElixirLS
-   **Dart** - Dart Language Server
-   **C/C++** - clangd
-   **Terraform** - terraform-ls

## メモリと知識管理

### メモリシステム
-   `.serena/memories/` ディレクトリへの**Markdownベースのストレージ**
-   **文脈に応じた取得** - 関連性に基づいてメモリを読み込み
-   **プロジェクト固有**の知識の永続化
-   **オンボーディングサポート** - 新規プロジェクトのガイド付きセットアップ

### 知識カテゴリ
-   **プロジェクト構造** - ディレクトリレイアウト、ビルドシステム
-   **アーキテクチャパターン** - コードベースの構成方法
-   **開発ワークフロー** - テスト、ビルド、デプロイ
-   **ドメイン知識** - ビジネスロジックと要件

## MCPサーバーインターフェース

Serenaは、Model Context Protocolを通じてその機能を提供します。
-   **ツール発見** - AIエージェントが利用可能なツールを列挙可能
-   **コンテキスト対応操作** - ツールはアクティブなプロジェクト/モードに基づいて動作
-   **ステートフルセッション** - 対話を通じてプロジェクトの状態を維持
-   **エラーハンドリング** - ツールが失敗した場合のグレースフルなデグラデーション

## エラーハンドリングと回復力

### 言語サーバーの信頼性
-   **タイムアウト管理** - LSPリクエストの構成可能なタイムアウト
-   **プロセス回復** - クラッシュした言語サーバーの自動再起動
-   **フォールバック動作** - LSPが利用できない場合のグレースフルなデグラデーション
-   **キャッシング戦略** - サーバー障害の影響を軽減

### プロジェクトアクティベーションの安全性
-   **検証** - アクティベート前にプロジェクト構造を検証
-   **エラー分離** - プロジェクトの失敗が他のプロジェクトに影響を与えない
-   **回復メカニズム** - 自動クリーンアップと再試行ロジック

## パフォーマンスに関する考慮事項

### キャッシング戦略
-   **シンボルキャッシュ** - コストの高いシンボル操作のインメモリキャッシング
-   **ファイルシステムキャッシュ** - 繰り返し操作でのディスクI/Oを削減
-   **言語サーバーキャッシュ** - セッションをまたいで永続化されるキャッシュ

### リソース管理
-   **言語サーバープーリング** - 可能な場合、プロジェクト間でサーバーを再利用
-   **メモリ管理** - 未使用リソースの自動クリーンアップ
-   **バックグラウンド操作** - 非同期操作がユーザーの対話をブロックしない

## 拡張ポイント

### 新しい言語の追加
1.  `src/solidlsp/language_servers/` に言語サーバークラスを実装
2.  ランタイム依存関係の設定を追加
3.  テストリポジトリとテストスイートを作成
4.  言語の列挙と設定を更新

### 新しいツールの追加
1.  `tools_base.py` の `Tool` 基底クラスを継承
2.  必要なメソッドとパラメータ検証を実装
3.  適切なツールレジストリにツールを登録
4.  必要に応じてコンテキスト/モード設定に追加

### カスタムコンテキストとモード
-   YAML設定ファイルで新しいコンテキストを定義
-   ツールセットと操作パターンを指定
-   特定の開発ワークフロー用に設定